AWSTemplateFormatVersion: 2010-09-09
Description: >-
  AWS VPC + Amazon Relational Database Service (RDS) for PostgreSQL.
  (qs-1saaatk1o)
Metadata:
  LICENSE: Apache License Version 2.0
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network configuration
        Parameters:
          - KeyPairName
          - AvailabilityZones
          - VPCCIDR
          - PrivateSubnet1CIDR
          - PrivateSubnet2CIDR
          - PublicSubnet1CIDR
          - PublicSubnet2CIDR
      - Label:
          default: Linux bastion configuration
        Parameters:
          - EnableBastion
          - RemoteAccessCIDR
          - EnableTCPForwarding
      - Label:
          default: Database configuration
        Parameters:
          - DBName
          - DBAccessCIDR
          - DBAutoMinorVersionUpgrade
          - DBAllowMajorVersionUpgrade
          - DBBackupRetentionPeriod
          - DBEngineVersion
          - DBInstanceClass
          - DBUsername
          - DBPassword
          - DBPort
          - DBAllocatedStorage
          - DBMaxAllocatedStorage
          - DBStorageType
          - DBIops
          - DBAllocatedStorageEncrypted
          - DBExportLogToCloudwatch
          - DBMultiAZ
          - DBMonitoringInterval
          - EnableEventSubscription
          - NotificationList
      - Label:
          default: Database tags (optional)
        Parameters:
          - EnvironmentStage
          - Application
          - ApplicationVersion
          - ProjectCostCenter
          - Confidentiality
          - Compliance
      - Label:
          default: Quick Start configuration
        Parameters:
          - QSS3BucketName
          - QSS3BucketRegion
          - QSS3KeyPrefix
    ParameterLabels:
      DBAllocatedStorage:
        default: Amount of storage (in gigabytes)
      DBMaxAllocatedStorage:
        default: Max allocated storage
      DBStorageType:
        default: Storage type
      DBIops:
        default: IOPS
      AvailabilityZones:
        default: Availability Zones
      DBEngineVersion:
        default: Engine version
      DBName:
        default: Name
      DBAllocatedStorageEncrypted:
        default: Enable encryption
      DBExportLogToCloudwatch:
        default: Export database log to CloudWatch
      DBAutoMinorVersionUpgrade:
        default: Database auto minor version upgrade
      DBAllowMajorVersionUpgrade:
        default: Database allow major version upgrade
      DBBackupRetentionPeriod:
        default: Database backup retention period
      DBInstanceClass:
        default: Database instance class
      DBUsername:
        default: Username
      DBPassword:
        default: Password
      DBPort:
        default: Port
      DBAccessCIDR:
        default: Database connection CIDR
      DBMultiAZ:
        default: Multi-AZ deployment
      DBMonitoringInterval:
        default: Monitoring interval
      EnableBastion:
        default: Create bastion stack
      EnableTCPForwarding:
        default: Enable TCP forwarding
      PrivateSubnet1CIDR:
        default: Private subnet 1 CIDR
      PrivateSubnet2CIDR:
        default: Private subnet 2 CIDR
      PublicSubnet1CIDR:
        default: Public subnet 1 CIDR
      PublicSubnet2CIDR:
        default: Public subnet 2 CIDR
      QSS3BucketName:
        default: Bucket name
      QSS3BucketRegion:
        default: Bucket region
      QSS3KeyPrefix:
        default: Key prefix
      VPCCIDR:
        default: VPC CIDR
      EnableEventSubscription:
        default: Enable event subscription
      NotificationList:
        default: SNS notification email
      EnvironmentStage:
        default: Environment stage
      Application:
        default: Application name
      ApplicationVersion:
        default: Application version
      Compliance:
        default: Compliance classifier
      Confidentiality:
        default: Confidentiality classifier
      ProjectCostCenter:
        default: Project cost center
      KeyPairName:
        default: Key name
      RemoteAccessCIDR:
        default: Permitted IP range
  cfn-lint:
    config:
      ignore_checks:
        - E9101
      ignore_reasons:
        - E9101: Not applicable as AWS::RDS::DBInstance has properties called “MasterUsername” and “MasterUserPassword
Parameters:
  AvailabilityZones:
   Description: >-
      List of Availability Zones to use for the subnets in the VPC. Only two
      Availability Zones are used for this deployment, and the logical order of
      your selections is preserved.
   Type: List<AWS::EC2::AvailabilityZone::Name>
  KeyPairName:
    ConstraintDescription: Name of an existing EC2 key pair.
    Description: Name of an existing public/private key pair, for connecting to your instance.
    Type: AWS::EC2::KeyPair::KeyName
  PrivateSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/19
    Description: CIDR block for private subnet 1 located in Availability Zone 1.
    Type: String
  PrivateSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.32.0/19
    Description: CIDR block for private subnet 2 located in Availability Zone 2.
    Type: String
  PublicSubnet1CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.128.0/20
    Description: CIDR block for the public subnet 1 located in Availability Zone 1.
    Type: String
  PublicSubnet2CIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.144.0/20
    Description: CIDR block for the public subnet 2 located in Availability Zone 2.
    Type: String
  RemoteAccessCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x
    Description: Allowed CIDR block for external SSH access.
    Default: 10.0.0.0/16
    Type: String
  VPCCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC.
    Type: String
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: aws-quickstart
    Description: S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Type: String
  QSS3BucketRegion:
    Default: us-east-1
    Description: The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is hosted. When using your own bucket, you must specify this value.
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/).
    Default: quickstart-amazon-rds-postgres/
    Description: S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/).
    Type: String
  EnableBastion:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Description: If true, a bastion stack will be created.
    Type: String
  DBAllocatedStorage:
    Default: 100
    Description: Amount of storage (in gigabytes)
    Type: Number
  DBMaxAllocatedStorage:
    Default: 1000
    Description: The upper limit in gigabytes to which Amazon RDS can automatically scale the storage
    Type: Number
  DBAllocatedStorageEncrypted:
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Whether or not to encrypt the database.
    Type: String
  DBIops:
    Type: Number
    Description: Must be in the range of 1,000 - 256,000 IOPS.
    MinValue: 1000
    MaxValue: 256000
    ConstraintDescription: Must be in the range 1,000 - 256,000 IOPS.
    Default: 3000
  DBExportLogToCloudwatch:
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Whether or not to export Database logs to Cloudwatch
    Type: String
  EnableTCPForwarding:
    Type: String
    Description: Enable/Disable TCP Forwarding
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
  DBAutoMinorVersionUpgrade:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'
    Description: Select true to set up auto minor version upgrade.
    Type: String
  DBAllowMajorVersionUpgrade:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'false'
    Description: Select true to set up major version upgrade.
    Type: String
  DBBackupRetentionPeriod:
    Default: 35
    Description: The number of days for which automatic database snapshots are retained.
    Type: String
  DBEngineVersion:
    Description: Select Database Engine Version
    Type: String
    Default: 14.4
    AllowedValues:
      - 10.17
      - 10.18
      - 10.19
      - 10.20
      - 10.21
      - 11.12
      - 11.13
      - 11.14
      - 11.15
      - 11.16
      - 12.7
      - 12.8
      - 12.9
      - 12.10
      - 12.11
      - 13.3
      - 13.4
      - 13.5
      - 13.6
      - 13.7
      - 14.1
      - 14.2
      - 14.3
      - 14.4
  DBInstanceClass:
    AllowedPattern: ^db\.[a-z0-9]+\.[a-z0-9]+$
    ConstraintDescription: Must select a valid database instance type.
    Default: db.m6g.large
    Description: The name of the compute and memory capacity class of the database instance.
    Type: String
  DBAccessCIDR:
    Type: String
    Description: Allowed CIDR block for external access (use VPC CIDR).
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/x
    Default: 10.0.0.0/16
  DBPassword:
    Type: String
    Description: The database admin account password.
    MinLength: 8
    MaxLength: 128
    AllowedPattern: ^[^/'\"@]+$
    ConstraintDescription: >-
      8 to 128 printable ASCII characters. Can''t contain any of the following:
      slash (/), single quote (''), double quote ("), or at sign (@).
    NoEcho: True
  DBUsername:
    Type: String
    Description: The database admin account username.
    MinLength: 1
    MaxLength: 16
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9]*$
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters.
    Default: pgadmin
  DBMonitoringInterval:
    AllowedValues:
      - 0
      - 1
      - 5
      - 15
      - 30
      - 60
    Default: 60
    Description: Enhanced Monitoring metrics interval in seconds. To disable Enhanced Monitoring metrics, specify 0.
    Type: Number
  DBPort:
    Default: 5432
    Description: The port the instance will listen for connections on.
    Type: Number
    ConstraintDescription: Must be in the range [1115-65535].
    MinValue: 1150
    MaxValue: 65535
  DBMultiAZ:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Description: Specifies if the database instance is a multiple Availability Zone deployment.
    Type: String
  DBName:
    AllowedPattern: ^[a-zA-Z][a-zA-Z0-9]*$
    Default: RDSPostgresDB
    Description: Name of the Amazon RDS (PostgreSQL) database.
    MaxLength: 64
    MinLength: 5
    Type: String
  DBStorageType:
    Type: String
    Description: >-
      Storage type. For additional information, see:
      https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_Storage.html.
    AllowedValues:
      - io1
      - gp2
    Default: io1
  EnableEventSubscription:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Description: Enables event subscription to Notification List
    Type: String
  NotificationList:
    Type: String
    Default: db-ops@domain.com
    Description: The Email notification is used to configure a SNS topic for sending cloudwatch alarm and RDS Event notifications
    AllowedPattern: ^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$
    ConstraintDescription: provide a valid email address.
  EnvironmentStage:
    Type: String
    Description: Designates the environment stage of the associated AWS resource. (Optional)
    AllowedValues:
      - dev
      - test
      - pre-prod
      - prod
      - none
    Default: none
  Application:
    Type: String
    Default: ''
    Description: Designates the application of the associated AWS resource. (Optional)
  ApplicationVersion:
    Type: String
    Description: Designates the specific version of the application. (Optional)
    Default: ''
  ProjectCostCenter:
    Type: String
    Default: ''
    Description: Designates the cost center associated with the project of the given AWS resource. (Optional)
  Confidentiality:
    Type: String
    Default: ''
    Description: Designates the confidentiality classification of the data that is associated with the resource. (Optional)
    AllowedValues:
      - public
      - private
      - confidential
      - pii/phi
      - none
      - ''
  Compliance:
    Type: String
    Default: ''
    Description: Designates the compliance level for the AWS resource. (Optional)
    AllowedValues:
      - hipaa
      - sox
      - fips
      - other
      - ''
Conditions:
  EnableBastionAccess: !Equals [!Ref EnableBastion, 'true']
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, aws-quickstart]
Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/quickstart-aws-vpc/templates/aws-vpc.template.yaml
        - S3Region: !If [UsingDefaultBucket, !Ref AWS::Region, !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        AvailabilityZones: !Join [',', !Ref AvailabilityZones]
        NumberOfAZs: 2
        PrivateSubnet1ACIDR: !Ref PrivateSubnet1CIDR
        PrivateSubnet2ACIDR: !Ref PrivateSubnet2CIDR
        PublicSubnet1CIDR: !Ref PublicSubnet1CIDR
        PublicSubnet2CIDR: !Ref PublicSubnet2CIDR
        VPCCIDR: !Ref VPCCIDR
  RDSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        !Sub
          - https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/rds_postgres.template.yaml
          - S3Region: !If [UsingDefaultBucket, !Ref AWS::Region, !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        Subnet1ID: !GetAtt VPCStack.Outputs.PrivateSubnet1AID
        Subnet2ID: !GetAtt VPCStack.Outputs.PrivateSubnet2AID
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        DBName: !Ref DBName
        DBAutoMinorVersionUpgrade: !Ref DBAutoMinorVersionUpgrade
        DBAllocatedStorage: !Ref DBAllocatedStorage
        DBStorageType: !Ref DBStorageType
        DBIops: !Ref DBIops
        DBAllowMajorVersionUpgrade: !Ref DBAllowMajorVersionUpgrade
        DBMaxAllocatedStorage: !Ref DBMaxAllocatedStorage
        DBAllocatedStorageEncrypted: !Ref DBAllocatedStorageEncrypted
        DBExportLogToCloudwatch: !Ref DBExportLogToCloudwatch
        DBBackupRetentionPeriod: !Ref DBBackupRetentionPeriod
        DBEngineVersion: !Ref DBEngineVersion
        DBInstanceClass: !Ref DBInstanceClass
        DBUsername: !Ref DBUsername
        DBPassword: !Ref DBPassword
        DBMonitoringInterval: !Ref DBMonitoringInterval
        DBPort: !Ref DBPort
        DBMultiAZ: !Ref DBMultiAZ
        DBAccessCIDR: !Ref DBAccessCIDR
        EnableEventSubscription: !Ref EnableEventSubscription
        NotificationList: !Ref NotificationList
        EnvironmentStage: !Ref EnvironmentStage
        Application: !Ref Application
        ApplicationVersion: !Ref ApplicationVersion
        ProjectCostCenter: !Ref ProjectCostCenter
        Confidentiality: !Ref Confidentiality
        Compliance: !Ref Compliance
  BastionStack:
    Condition: EnableBastionAccess
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        !Sub
          - https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/quickstart-linux-bastion/templates/linux-bastion-entrypoint-existing-vpc.template.yaml
          - S3Region: !If [UsingDefaultBucket, !Ref AWS::Region, !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        KeyPairName: !Ref KeyPairName
        PublicSubnet1ID: !GetAtt VPCStack.Outputs.PublicSubnet1ID
        PublicSubnet2ID: !GetAtt VPCStack.Outputs.PublicSubnet2ID
        EnableTCPForwarding: !Ref EnableTCPForwarding
        RemoteAccessCIDR: !Ref RemoteAccessCIDR
        VPCID: !GetAtt VPCStack.Outputs.VPCID
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Sub ${QSS3KeyPrefix}submodules/quickstart-linux-bastion/